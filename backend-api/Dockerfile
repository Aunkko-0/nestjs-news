# --- Stage 1: Build ---
FROM node:18-alpine AS builder

WORKDIR /app

# 1. ‡∏•‡∏á Dependencies
COPY package*.json ./
COPY prisma ./prisma/
RUN npm install

# 2. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ Source Code ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
COPY . .

# 3. Generate Prisma & Build
RUN npx prisma generate
RUN npm run build

# üîç DEBUG: ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ List ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡∏π‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤ main.js ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏ô
# (‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô Log ‡∏ï‡∏≠‡∏ô Build ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏û‡∏±‡∏á‡∏≠‡∏µ‡∏Å)
RUN echo "üìÇ Checking dist folder structure:" && ls -R dist

# --- Stage 2: Production ---
FROM node:18-alpine

WORKDIR /app

# 1. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ package.json ‡πÅ‡∏•‡∏∞ prisma
COPY package*.json ./
COPY prisma ./prisma/

# 2. ‡∏•‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Production Dependencies (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ö‡∏≤)
RUN npm install --only=production

# 3. Generate Prisma Client (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Production environment)
RUN npx prisma generate

# 4. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà Build ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å Stage 1
# ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ path ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å
COPY --from=builder /app/dist ./dist

EXPOSE 3000

# 5. ‡∏£‡∏±‡∏ô Server
# ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ node ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ npm script error
CMD ["node", "dist/main"]