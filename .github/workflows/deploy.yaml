name: 2. CD - Deploy to Server

on:
  workflow_run:
    workflows: ["1. CI - Build & Push Docker Images to GHCR"] # ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πä‡∏∞‡πÜ
    types:
      - completed
  
  # ‡∏¢‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö workflow_run (‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ CI ‡∏à‡∏ö‡πÅ‡∏ö‡∏ö Success ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏£‡∏±‡∏ô‡πÄ‡∏≠‡∏á
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: SSH to Server and Restart Containers
        uses: appleboy/ssh-action@master
        env:
          # ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏∑‡πà‡∏≠ Image (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å aunkko-0 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
          BACKEND_IMAGE: ghcr.io/aunkko-0/nestjs-news-backend:latest
          FRONTEND_IMAGE: ghcr.io/aunkko-0/nestjs-news-frontend:latest
          GHCR_OWNER: aunkko-0
        with:
          host: ${{ secrets.NEST_SSH }}
          username: ${{ secrets.NEST_SSH_USERNAME }}
          key: ${{ secrets.NEST_PRIVATE_KEY }}
          # ‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ env ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô Server
          envs: BACKEND_IMAGE,FRONTEND_IMAGE,GHCR_OWNER
          script: |
            # 1. Login GHCR (‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ user ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤)
            echo ${{ secrets.NEST_GHCR_PAT }} | docker login ghcr.io -u $GHCR_OWNER --password-stdin

            # 2. Pull Images (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å)
            echo "‚¨áÔ∏è Pulling images..."
            docker pull $BACKEND_IMAGE
            docker pull $FRONTEND_IMAGE

            # 3. ‡∏•‡∏ö Container ‡πÄ‡∏î‡∏¥‡∏°
            echo "üõë Stopping old containers..."
            docker stop nestjs-backend || true && docker rm nestjs-backend || true
            docker stop nestjs-frontend || true && docker rm nestjs-frontend || true

            # 4. Run Container ‡πÉ‡∏´‡∏°‡πà
            echo "üöÄ Starting Backend..."
            docker run -d --name nestjs-backend --restart unless-stopped -p 3000:3000 $BACKEND_IMAGE
            
            echo "üé® Starting Frontend..."
            docker run -d --name nestjs-frontend --restart unless-stopped -p 80:80 $FRONTEND_IMAGE
            
            # 5. ‡∏•‡πâ‡∏≤‡∏á Image ‡πÄ‡∏Å‡πà‡∏≤
            docker image prune -f