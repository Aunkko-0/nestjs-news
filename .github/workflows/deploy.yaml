# name: 2. CD - Deploy to Kubernetes

# on:
#   workflow_run:
#     workflows: ["1. CI - Build & Push Docker Images to GHCR"]
#     types:
#       - completed
#   workflow_dispatch:

# jobs:
#   deploy-k8s:
#     runs-on: ubuntu-latest
    # if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
#     steps:
#       - name: Checkout Source
#         uses: actions/checkout@v4

#       # ---------------------------------------------------------
#       # 1. ‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå YAML ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Master Node
#       # ---------------------------------------------------------
#       - name: Copy K8s Manifests to Master Node
#         uses: appleboy/scp-action@master
#         with:
#           host: ${{ secrets.NEST_SSH_HOST }}      # IP ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Master
#           username: ${{ secrets.NEST_SSH_USERNAME }}
#           key: ${{ secrets.NEST_SSH_KEY }}
#           source: "k8s/*"
#           target: "/home/ubuntu/deploy-k8s"       # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ß‡∏≤‡∏á
#           strip_components: 1                     # ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏°‡πà (k8s/) ‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏ï‡πà‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô

#       # ---------------------------------------------------------
#       # 2. SSH ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á Deploy
#       # ---------------------------------------------------------
#       - name: SSH and Apply to Kubernetes
#         uses: appleboy/ssh-action@master
#         env:
#           # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ Secret ‡∏à‡∏≤‡∏Å GitHub ‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
#           # ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÉ‡∏ô GitHub Secrets ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ DATABASE_URL ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ä‡πà‡∏ô postgres://...)
#           DATABASE_URL_REAL: ${{ secrets.DATABASE_URL }}
#         with:
#           host: ${{ secrets.NEST_SSH_HOST }}
#           username: ${{ secrets.NEST_SSH_USERNAME }}
#           key: ${{ secrets.NEST_SSH_KEY }}
#           envs: DATABASE_URL_REAL
#           script: |
#             # 1. ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå
#             cd /home/ubuntu/deploy-k8s

#             # 2. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤ DATABASE_URL_PLACEHOLDER ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á sed)
#             # -i = ‡πÅ‡∏Å‡πâ‡∏ó‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°
#             # ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ | ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡πÅ‡∏ó‡∏ô / ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ô URL database ‡∏°‡∏±‡∏ô‡∏°‡∏µ / ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß error
#             sed -i "s|DATABASE_URL_PLACEHOLDER|$DATABASE_URL_REAL|g" backend.yaml

#             # 3. ‡∏™‡∏±‡πà‡∏á Apply ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
#             echo "üî• Applying Kubernetes Manifests..."
#             kubectl apply -f backend.yaml
#             kubectl apply -f frontend.yaml

#             # 4. ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ K8s ‡∏î‡∏∂‡∏á Image ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (Zero Downtime)
#             # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏±‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ K8s ‡∏à‡∏∞‡∏ô‡∏∂‡∏Å‡∏ß‡πà‡∏≤ Image ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
#             echo "üîÑ Rolling out restarts..."
#             kubectl rollout restart deployment/nestjs-backend
#             kubectl rollout restart deployment/nestjs-frontend

#             # 5. ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à (Optional: ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ß‡πâ‡∏î‡∏π log ‡∏™‡∏ß‡∏¢‡πÜ)
#             kubectl rollout status deployment/nestjs-backend
#             kubectl rollout status deployment/nestjs-frontend