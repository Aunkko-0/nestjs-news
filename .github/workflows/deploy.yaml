name: 2. CD - Deploy to Server

on:
  workflow_run:
    workflows: ["1. CI - Build & Push Docker Images to GHCR"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 # üëà ‡∏ï‡πâ‡∏≠‡∏á checkout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÑ‡∏ü‡∏•‡πå docker-compose.yml

      # 1. ‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏ü‡∏•‡πå docker-compose.yml ‡∏Ç‡∏∂‡πâ‡∏ô Server
      - name: Copy docker-compose to Server via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.NEST_SSH }}
          username: ${{ secrets.NEST_SSH_USERNAME }}
          key: ${{ secrets.NEST_PRIVATE_KEY }}
          source: "docker-compose.yml"
          target: "/home/ubuntu/my-app" # üëà ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö

      # 2. SSH ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á Run
      - name: SSH to Server and Deploy
        uses: appleboy/ssh-action@master
        env:
          GHCR_OWNER: aunkko-0
        with:
          host: ${{ secrets.NEST_SSH }}
          username: ${{ secrets.NEST_SSH_USERNAME }}
          key: ${{ secrets.NEST_PRIVATE_KEY }}
          envs: GHCR_OWNER
          script: |
            # ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏á‡∏≤‡∏ô
            cd /home/ubuntu/my-app

            # Login
            echo ${{ secrets.NEST_GHCR_PAT }} | docker login ghcr.io -u $GHCR_OWNER --password-stdin

            # Pull Image ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (Compose ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå yml ‡πÄ‡∏≠‡∏á)
            docker compose pull

            # ‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤ + ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤ + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß!)
            # -d = run background
            # --remove-orphans = ‡∏•‡∏ö container ‡∏Ç‡∏¢‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå yml ‡∏ó‡∏¥‡πâ‡∏á
            docker compose up -d --remove-orphans

            # (Optional) ‡∏•‡πâ‡∏≤‡∏á Image ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            docker image prune -f